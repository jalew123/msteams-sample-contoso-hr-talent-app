<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="/config.js"></script>
    <script src="https://unpkg.com/@microsoft/mgt/dist/bundle/mgt-loader.js"></script>
    <meta charset="utf-8" />
    <title>Proactive Messaging Form</title>
    <script type="text/javascript">


        function showGroupDiv() {
            $("#personalOrChannel").hide();
            $("#groupDiv").show();
        };

        function showChannelDiv() {
            $("#personalOrChannel").hide();
            $("#channelDiv").show();
        };

        function showPersonalDiv() {
            $("#personalOrChannel").hide();
            $("#personalDiv").show();
        };

        //get the data from the people picker
        async function getDataFromPeoplePicker() {
            $("#adminConsentSuccessful, #successfulRequest, #consentRequired, #UPNdoesntexist ,#installRequired ,#badRequest, #serverError").hide();
            var personsObject = document.querySelector('mgt-people-picker').selectedPeople;
            console.log(personsObject);
            var ids = personsObject.map(user => user.id)
            console.log(ids);
            let tenantid = document.getElementById("tenantid2").value;
            //ids contains an array of the selected peoples Ids. We now need to pass this in the fetch request to the api



            //get tenantId by making another graph call... Or pull it from the access token... Or just add a text box...




            $("#sendingRequest").show();
            submittoApiGroupMessage(ids, tenantid);

        };

        async function submittoApiGroupMessage(ids, tenantId) {
            //todo: write the fetch request to send ids and tenantid to the API
            //generate and send request to api controllers
            let data = await fetch(window.location.origin + '/api/notifyGroup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 'Upns': ids, 'tenantId': tenantId, 'text': 'hello' })
            });

            $("#sendingRequest").hide();

            //deal with response from server
            if (data.ok) {
                console.log("HTTP Status: " + data.status);
                console.log(data);
                if (data.status >= 200 && data.status < 300) {
                    $("#successfulRequest > span").html(data.status);
                    $("#successfulRequest").show();
                }

            } else {
                console.error("HTTP-Error: " + data.status);

                if (data.status == '403') {
                    $("#consentRequired").show();
                }
                if (data.status == '404') {
                    $("#UPNdoesntexist").show();
                }
                if (data.status == '412') {
                    $("#installRequired").show();
                }
                if (data.status == '400') {
                    $("#badRequest").show();
                }
                if (data.status == '500') {
                    $("#serverError").show();
                }
            }

        }
            



        //get the data from the channel picker
        function getDataFromChannelPicker() {
            $("#adminConsentSuccessful, #successfulRequest, #consentRequired, #UPNdoesntexist ,#installRequired ,#badRequest, #serverError").hide();
            const channelPicker = document.querySelector('mgt-teams-channel-picker');
            console.log(channelPicker.selectedItem);
            let channelId = channelPicker.selectedItem.channel.id;
            let channelName = channelPicker.selectedItem.channel.displayName;
            let teamName = channelPicker.selectedItem.team.displayName;
            $("#sendingRequest").show();
            submittoApiChannelMessage(channelId, channelName, teamName);

        };

        async function submittoApiChannelMessage(channelId, tenantId) {
            //generate and send request to api controllers
            let data = await fetch(window.location.origin + '/api/notifyChannel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 'channelId': channelId, 'tenantId': tenantId, 'text': 'hello' })
            });

            $("#sendingRequest").hide();

            //deal with response from server
            if (data.ok) {
                console.log("HTTP Status: " + data.status);
                console.log(data);
                if (data.status >= 200 && data.status < 300) {
                    $("#successfulRequest > span").html(data.status);
                    $("#successfulRequest").show();
                }

            } else {
                console.error("HTTP-Error: " + data.status);

                if (data.status == '403') {
                    $("#consentRequired").show();
                }
                if (data.status == '404') {
                    $("#UPNdoesntexist").show();
                }
                if (data.status == '412') {
                    $("#installRequired").show();
                }
                if (data.status == '400') {
                    $("#badRequest").show();
                }
                if (data.status == '500') {
                    $("#serverError").show();
                }
            }

        }

        //gets the data from the form (UPN & TenantId)
        function getDataFromForm(type) {
            $("#adminConsentSuccessful, #successfulRequest, #consentRequired, #UPNdoesntexist ,#installRequired ,#badRequest, #serverError").hide();

            let methodType = type
            let upn = document.getElementById("upn").value;
            let tenantid = document.getElementById("tenantid").value;
            $("#sendingRequest").show();
            //calls the submitToApi function and passes into the function the form values
            submitToApi(upn, tenantid, methodType)

        };

        async function submitToApi(upn, tenantid, methodType) {
            //generate and send request to api controllers
            let data = await fetch(window.location.origin + '/api/' + methodType, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 'id': upn, 'tenantId': tenantid, 'text': 'hello' })
            });

            $("#sendingRequest").hide();


            //deal with response from server
            if (data.ok) {
                console.log("HTTP Status: " + data.status);
                console.log(data);
                if (data.status >= 200 && data.status < 300) {
                    $("#successfulRequest > span").html(data.status);
                    $("#successfulRequest").show();
                }

            } else {
                console.error("HTTP-Error: " + data.status);

                if (data.status == '403') {
                    $("#consentRequired").show();
                }
                if (data.status == '404') {
                    $("#UPNdoesntexist").show();
                }
                if (data.status == '412') {
                    $("#installRequired").show();
                }
                if (data.status == '400') {
                    $("#badRequest").show();
                }
                if (data.status == '500') {
                    $("#serverError").show();
                }
            }

        };

        //redirects to the Admin Consent URL, if the Grant Consent button is clicked
        function redirectToAdminConsent() {
            let clientId = window.global.microsoftAppId;
            let redirectUri = window.location.origin + "/StaticViews/ProactiveMessaging.html";
            let adminConsentURL = 'https://login.microsoftonline.com/common/adminconsent?client_id=' + clientId + '&redirect_uri=' + redirectUri;
            console.log(adminConsentURL);
            window.location.assign(adminConsentURL);
        }

        //logic to capture succesful or unsuccesful consent after redirect back from Azure AD
        $(() => {


            var urlParams = new URLSearchParams(window.location.search);
            var adminConsent = urlParams.get('admin_consent');
            if (adminConsent == 'True') {
                $("#adminConsentSuccessful").show();
            }

        });


    </script>

</head>
<body>
    <div>
        <h1>
            Please submit the UPN and TenantID of the user into the form, to either Install the App, using Graph API or Send the User a proactive message, via the Bot.
        </h1>
    </div>
    <!--

        -->
    <div id="personalOrChannel">
        <button id="buttonTeamChannel" onclick="showChannelDiv();">Interact with a Team Channel</button>
        <button id="buttonPersonal" onclick="showPersonalDiv();">Interact with an individual user</button>
        <button id="buttonGroup" onclick="showGroupDiv();">Interact with a Group Chat</button>
    </div>

    <div id="channelDiv" style="display: none;">

        <mgt-msal2-provider client-id="6a56bee2-c36e-4838-a0c2-7cf53be8bcd0" scopes="user.read,people.read"></mgt-msal2-provider>
        <mgt-login></mgt-login>
        Please select a Team Channel to Proactively Message:
        <mgt-teams-channel-picker></mgt-teams-channel-picker>
        <button id="buttonProactiveChannelMessage" onclick="getDataFromChannelPicker()">Send 'hello' to channel via Bot Proactive Message</button>
    </div>

    <div id="groupDiv" style="display: none;">

        <mgt-login></mgt-login>
        Please select the people you want to Proactively Message in a Group Chat:
        <mgt-people-picker user-type="user"></mgt-people-picker>
        <label>TenantId</label> <br>
        <input id="tenantid2" type="text" size="40" placeholder="GUID of TenantID">  <br> <br>
        <button id="buttonProactiveGroupMessage" onclick="getDataFromPeoplePicker()">Send 'hello' in Group Chat via Bot Proactive Message</button>
    </div>

    <div id="personalDiv" style="display: none;">
        <form id="form1">
            <label>UPN</label> <br>
            <input id="upn" type="text" size="40" placeholder="alias@domain.com"> <br> <br>
            <label>TenantId</label> <br>
            <input id="tenantid" type="text" size="40" placeholder="GUID of TenantID">  <br> <br>
        </form>
        <button id="buttonProactiveInstall" onclick="getDataFromForm('installbot')">Install Bot for User</button>
        <button id="buttonProactiveMessage" onclick="getDataFromForm('notify')">Send 'hello' to user via Bot Proactive Message</button>
    </div>

    <br />
    <br />
    <br />

    <div id="sendingRequest" style="display: none;">
        Sending request...
    </div>

    <div id="successfulRequest" style="display: none;">
        <span></span> Success! Please login to Teams to review.
    </div>

    <div id="consentRequired" style="display: none;">
        403 Forbidden error - Consent must be granted to allow Proactive Install/Messaging. Please click the below button to grant Consent and then try again.
        <button id="buttonConsent" onclick="redirectToAdminConsent();">Grant Consent</button>
    </div>

    <div id="adminConsentSuccessful" style="display: none;">
        Admin Consent successful, please try to Proactively Install/Message again!
    </div>

    <div id="UPNdoesntexist" style="display: none;">
        404 Forbidden error - user alias / upn doesn't exist in tenant - Please review the details your submitted and try again.
    </div>

    <div id="installRequired" style="display: none;">
        412 Precondition failed error - The app, that contains the bot, must be installed in this scope before you can proactivelly message. Press the 'Install Bot' button to install the bot into this scope and then try again.
    </div>

    <div id="badRequest" style="display: none;">
        400 Bad Request error - Something went wrong with the request, please review the network developer tools to review the request, and try again.
    </div>

    <div id="serverError" style="display: none;">
        500 Server error - Something went wrong, please review the network developer tools to review the request, and add a breakpoint to the controller endpoint to see what's causing the issue.
    </div>

</body>
    </html>
